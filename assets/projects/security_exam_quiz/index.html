<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security+ SY0-701 Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
        }
        .heartbeat {
            animation: heartbeat 1.5s ease-in-out infinite both;
        }
        @keyframes heartbeat {
            from { transform: scale(1); transform-origin: center center; animation-timing-function: ease-out; }
            10% { transform: scale(0.91); animation-timing-function: ease-in; }
            17% { transform: scale(0.98); animation-timing-function: ease-out; }
            33% { transform: scale(0.87); animation-timing-function: ease-in; }
            45% { transform: scale(1); animation-timing-function: ease-out; }
        }
        .quiz-option {
            transition: all 0.2s ease-in-out;
        }
        .quiz-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .quiz-option.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
        }
        .quiz-option.correct-answer {
            background-color: #16a34a; /* green-600 */
            color: white;
            border-color: #15803d; /* green-700 */
        }
        .quiz-option.incorrect-answer {
            background-color: #dc2626; /* red-600 */
            color: white;
            border-color: #b91c1c; /* red-700 */
        }
        .quiz-option.user-selected {
            outline: 2px solid #2563eb; /* blue-600 */
            outline-offset: 2px;
        }
        .explanation-box {
            background-color: #f3f4f6; /* gray-100 */
            border-left: 4px solid #6b7280; /* gray-500 */
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 0.25rem;
        }
        /* Loading Spinner */
        #loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Loading Spinner Overlay -->
    <div id="loader-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
        <div id="loader"></div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">CompTIA Security+ SY0-701 Quiz</h1>
            <p class="text-lg text-gray-600 mt-2">Test your knowledge and prepare for the exam.</p>
        </header>

        <!-- Quiz Setup Section -->
        <div id="setup-section" class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-2xl font-bold mb-4">Exam Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label for="domain-select" class="block text-sm font-medium text-gray-700 mb-2">Select Domain:</label>
                    <select id="domain-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All Domains</option>
                        <!-- Domains will be populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="question-count" class="block text-sm font-medium text-gray-700 mb-2">Number of Questions:</label>
                    <select id="question-count" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="seed-input" class="block text-sm font-medium text-gray-700 mb-2">Start from Seed (Optional):</label>
                    <input type="text" id="seed-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Paste a seed value from your history">
                </div>
                <div>
                    <label for="exam-type" class="block text-sm font-medium text-gray-700 mb-2">Exam Type:</label>
                    <select id="exam-type" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="practice">Practice Mode</option>
                        <option value="exam">Exam Mode</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="start-exam" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md text-base">Start Exam</button>
            </div>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="hidden bg-white p-6 rounded-lg shadow-lg mb-8">
            <div class="flex justify-between items-center mb-4">
                <div id="progress-indicator" class="text-sm font-medium text-gray-600"></div>
                <div id="timer" class="text-xl font-bold text-red-600"></div>
            </div>
            <div id="question-container" class="min-h-[450px]"></div>
            <div class="mt-6 flex justify-between items-center">
                <button id="prev-question" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition duration-300">Previous</button>
                <button id="next-question" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition duration-300">Next</button>
                <button id="submit-exam" class="hidden bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300">Submit</button>
            </div>
        </div>
        
        <!-- Review Section -->
        <div id="review-section" class="hidden bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-3xl font-bold mb-4 text-center">Review Your Answers</h2>
            <div id="review-container" class="min-h-[500px]"></div>
            <div class="mt-6 flex justify-between items-center">
                <button id="prev-review-question" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition duration-300">Previous</button>
                <div id="review-progress-indicator" class="text-sm font-medium text-gray-600"></div>
                <button id="next-review-question" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition duration-300">Next</button>
            </div>
             <div class="mt-6 text-center">
                <button id="back-to-results" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition duration-300">Back to Results</button>
            </div>
        </div>


        <!-- Results Section -->
        <div id="results-section" class="hidden bg-white p-6 rounded-lg shadow-lg text-center">
            <h2 class="text-3xl font-bold mb-4">Exam Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-lg">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="font-bold">Score:</p>
                    <p id="score" class="text-2xl font-bold text-green-600"></p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="font-bold">Percentage:</p>
                    <p id="percentage" class="text-2xl font-bold text-blue-600"></p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="font-bold">Time Taken:</p>
                    <p id="time-taken" class="text-2xl font-bold text-purple-600"></p>
                </div>
            </div>
            <div class="mt-8 flex justify-center gap-4">
                 <button id="review-exam" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-purple-700 transition duration-300">Review Answers</button>
                 <button id="restart-exam" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300">Take Another Exam</button>
            </div>
        </div>

        <!-- History Table Section -->
        <div id="history-section" class="bg-white p-6 rounded-lg shadow-lg mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Exam History</h2>
                <div class="flex items-center gap-2">
                    <button id="download-csv" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-300 text-sm"><i class="fas fa-download mr-1"></i> CSV</button>
                    <button id="download-json" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-300 text-sm"><i class="fas fa-download mr-1"></i> JSON</button>
                    <button id="reset-history" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300 text-sm"><i class="fas fa-trash-alt mr-1"></i> Reset</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-2 px-4 border-b">Seed</th>
                            <th class="py-2 px-4 border-b">Date</th>
                            <th class="py-2 px-4 border-b">Exam Type</th>
                            <th class="py-2 px-4 border-b">Score</th>
                            <th class="py-2 px-4 border-b">Percentage</th>
                            <th class="py-2 px-4 border-b">Time Taken</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Floating Support Icon -->
    <div id="support-icon" class="fixed bottom-8 right-8 cursor-pointer heartbeat z-50">
        <a href="https://buymeacoffee.com/gourabdg" target="_blank" class="block w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg text-white">
            <i class="fas fa-heart text-2xl"></i>
        </a>
    </div>

    <!-- Support Modal -->
    <div id="support-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm mx-auto">
            <h3 class="text-2xl font-bold mb-4">Support the Developer!</h3>
            <p class="mb-6 text-gray-700">If you find this quiz app helpful, please consider supporting my work. It helps me create more tools like this for the community.</p>
            <a href="https://buymeacoffee.com/gourabdg" target="_blank" class="bg-yellow-400 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-yellow-500 transition duration-300 block mb-3">
                <i class="fas fa-coffee mr-2"></i>Buy me a coffee
            </a>
            <button id="skip-support" class="bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-400 transition duration-300 w-full">Skip to Exam</button>
        </div>
    </div>
    
    <!-- Reset Confirmation Modal -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm mx-auto">
            <h3 class="text-2xl font-bold mb-4">Confirm Reset</h3>
            <p class="mb-6 text-gray-700">Are you sure you want to delete all exam history? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-reset-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition duration-300">Reset</button>
                <button id="cancel-reset-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition duration-300">Cancel</button>
            </div>
        </div>
    </div>
    
    <script src="questions.js"></script>
    <script>
        // Main script for the quiz application
        document.addEventListener('DOMContentLoaded', () => {
            // State variables
            let allQuestions = [];
            let currentQuestions = [];
            let userAnswers = [];
            let currentQuestionIndex = 0;
            let reviewQuestionIndex = 0;
            let examType = 'practice';
            let timer;
            let timeLeft = 0;
            let totalTime = 0;
            let examSeed = '';
            let activeSeed = '';
            let startTime = 0;
            let isQuizActive = false;

            // DOM Elements
            const setupSection = document.getElementById('setup-section');
            const quizSection = document.getElementById('quiz-section');
            const resultsSection = document.getElementById('results-section');
            const reviewSection = document.getElementById('review-section');
            const startExamBtn = document.getElementById('start-exam');
            const domainSelect = document.getElementById('domain-select');
            const questionCountSelect = document.getElementById('question-count');
            const examTypeSelect = document.getElementById('exam-type');
            const seedInput = document.getElementById('seed-input');
            const questionContainer = document.getElementById('question-container');
            const reviewContainer = document.getElementById('review-container');
            const prevQuestionBtn = document.getElementById('prev-question');
            const nextQuestionBtn = document.getElementById('next-question');
            const submitExamBtn = document.getElementById('submit-exam');
            const timerDisplay = document.getElementById('timer');
            const scoreDisplay = document.getElementById('score');
            const percentageDisplay = document.getElementById('percentage');
            const timeTakenDisplay = document.getElementById('time-taken');
            const restartExamBtn = document.getElementById('restart-exam');
            const reviewExamBtn = document.getElementById('review-exam');
            const historyTableBody = document.getElementById('history-table-body');
            const downloadCsvBtn = document.getElementById('download-csv');
            const downloadJsonBtn = document.getElementById('download-json');
            const resetHistoryBtn = document.getElementById('reset-history');
            const supportIcon = document.getElementById('support-icon');
            const supportModal = document.getElementById('support-modal');
            const skipSupportBtn = document.getElementById('skip-support');
            const progressIndicator = document.getElementById('progress-indicator');
            const reviewProgressIndicator = document.getElementById('review-progress-indicator');
            const resetModal = document.getElementById('reset-modal');
            const confirmResetBtn = document.getElementById('confirm-reset-btn');
            const cancelResetBtn = document.getElementById('cancel-reset-btn');
            const loaderOverlay = document.getElementById('loader-overlay');
            const prevReviewBtn = document.getElementById('prev-review-question');
            const nextReviewBtn = document.getElementById('next-review-question');
            const backToResultsBtn = document.getElementById('back-to-results');
            
            // --- INITIAL SETUP ---
            
            function loadQuestions() {
                if (typeof window.quizQuestions !== 'undefined') {
                    allQuestions = window.quizQuestions;
                } else {
                    console.error("Questions data could not be loaded. Make sure 'questions.js' is in the same directory.");
                    allQuestions = [];
                    alert("Error: questions.js could not be loaded. Please check the console for details.");
                }
                populateDomains();
                updateQuestionCountOptions(); // Initial population
            }

            function populateDomains() {
                const domains = [...new Set(allQuestions.map(q => q.domain))];
                domains.sort().forEach(domain => {
                    const option = document.createElement('option');
                    option.value = domain;
                    option.textContent = domain;
                    domainSelect.appendChild(option);
                });
            }

            function updateQuestionCountOptions() {
                const selectedDomain = domainSelect.value;
                const availableQuestions = selectedDomain === 'all' 
                    ? allQuestions 
                    : allQuestions.filter(q => q.domain === selectedDomain);
                
                const availableCount = availableQuestions.length;
                questionCountSelect.innerHTML = ''; // Clear existing options

                const options = [30, 60, 90, 120, 150];
                options.forEach(opt => {
                    if (opt <= availableCount) {
                        const optionElement = document.createElement('option');
                        optionElement.value = opt;
                        optionElement.textContent = `${opt} Questions`;
                        questionCountSelect.appendChild(optionElement);
                    }
                });
                
                if (availableCount > 0) {
                    const allOption = document.createElement('option');
                    allOption.value = availableCount;
                    allOption.textContent = `All ${availableCount} Questions`;
                    questionCountSelect.appendChild(allOption);
                }
            }


            // --- SEED-BASED PRNG ---
            function xmur3(str) {
                for(var i = 0, h = 1779033703 ^ str.length; i < str.length; i++) {
                    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
                    h = h << 13 | h >>> 19;
                }
                return function() {
                    h = Math.imul(h ^ h >>> 16, 2246822507);
                    h = Math.imul(h ^ h >>> 13, 3266489909);
                    return (h ^= h >>> 16) >>> 0;
                }
            }
            
            function mulberry32(a) {
                return function() {
                  var t = a += 0x6D2B79F5;
                  t = Math.imul(t ^ t >>> 15, t | 1);
                  t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                  return ((t ^ t >>> 14) >>> 0) / 4294967296;
                }
            }

            function shuffleArray(array, seed) {
                const seedFunc = xmur3(seed);
                const rand = mulberry32(seedFunc());
                let currentIndex = array.length, randomIndex;
                while (currentIndex != 0) {
                    randomIndex = Math.floor(rand() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
                return array;
            }

            function generateSeed() {
                return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            }

            // --- EXAM LOGIC ---

            function beginExam() {
                loaderOverlay.classList.remove('hidden');
                
                setTimeout(() => {
                    let numQuestions;
                    let questionsForQuiz;
                    let selectedDomain;

                    if (activeSeed) {
                        examSeed = activeSeed;
                        const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
                        const seedRecord = history.find(r => r.seed === activeSeed);
                        selectedDomain = seedRecord.domain;
                        questionsForQuiz = selectedDomain === 'all' 
                            ? allQuestions
                            : allQuestions.filter(q => q.domain === selectedDomain);
                        numQuestions = seedRecord.questionCount;
                    } else {
                        examSeed = generateSeed();
                        selectedDomain = domainSelect.value;
                        questionsForQuiz = selectedDomain === 'all' 
                            ? allQuestions 
                            : allQuestions.filter(q => q.domain === selectedDomain);
                        numQuestions = parseInt(questionCountSelect.value);
                    }

                    examType = examTypeSelect.value;
                    
                    const shuffledQuestions = shuffleArray([...questionsForQuiz], examSeed);
                    currentQuestions = shuffledQuestions.slice(0, numQuestions);
                    
                    userAnswers = new Array(currentQuestions.length).fill(null);
                    currentQuestionIndex = 0;
                    isQuizActive = true;
                    
                    setupSection.classList.add('hidden');
                    resultsSection.classList.add('hidden');
                    reviewSection.classList.add('hidden');
                    quizSection.classList.remove('hidden');
                    supportIcon.classList.add('hidden');

                    if (examType === 'exam') {
                        timeLeft = numQuestions * 60; // 1 minute per question
                        totalTime = timeLeft;
                        startTimer();
                    } else {
                        startTime = Date.now();
                        timerDisplay.textContent = 'Practice Mode';
                    }

                    displayQuestion();
                    loaderOverlay.classList.add('hidden');
                }, 500); // Simulate loading
            }
            
            function displayQuestion() {
                if (currentQuestionIndex >= currentQuestions.length) return;
                const question = currentQuestions[currentQuestionIndex];
                let optionsHtml = '';
                
                question.options.forEach((option, index) => {
                    const isSelected = userAnswers[currentQuestionIndex] === option;
                    optionsHtml += `
                        <div class="quiz-option p-4 border rounded-lg cursor-pointer mb-3 ${isSelected ? 'selected' : 'bg-gray-50'}" data-option-index="${index}">
                           <span class="font-bold mr-2">${index + 1}.</span> ${option}
                        </div>
                    `;
                });
                
                questionContainer.innerHTML = `
                    <h3 class="text-2xl font-semibold mb-4">${currentQuestionIndex + 1}. ${question.question}</h3>
                    <div id="options-container">${optionsHtml}</div>
                `;
                
                updateQuizNavigation();
                updateProgress();

                document.querySelectorAll('.quiz-option').forEach(el => {
                    el.addEventListener('click', (e) => handleOptionSelect(e.currentTarget));
                });
            }

            function handleOptionSelect(selectedElement) {
                const selectedIndex = parseInt(selectedElement.dataset.optionIndex);
                const selectedOption = currentQuestions[currentQuestionIndex].options[selectedIndex];
                userAnswers[currentQuestionIndex] = selectedOption;
                displayQuestion();
            }

            function updateProgress() {
                progressIndicator.textContent = `Question ${currentQuestionIndex + 1} of ${currentQuestions.length}`;
                if (currentQuestionIndex + 1 === Math.ceil(currentQuestions.length / 2) && currentQuestionIndex > 0) {
                    showSupportModal(false);
                }
            }

            function updateQuizNavigation() {
                prevQuestionBtn.disabled = currentQuestionIndex === 0;
                prevQuestionBtn.classList.toggle('opacity-50', prevQuestionBtn.disabled);
                nextQuestionBtn.textContent = userAnswers[currentQuestionIndex] === null ? 'Skip' : 'Next';
                
                if (currentQuestionIndex === currentQuestions.length - 1) {
                    nextQuestionBtn.classList.add('hidden');
                    submitExamBtn.classList.remove('hidden');
                } else {
                    nextQuestionBtn.classList.remove('hidden');
                    submitExamBtn.classList.add('hidden');
                }
            }
            
            function startTimer() {
                timerDisplay.classList.remove('hidden');
                timer = setInterval(() => {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerDisplay.textContent = `Time Left: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        submitExam();
                    }
                }, 1000);
            }

            function submitExam() {
                clearInterval(timer);
                isQuizActive = false;
                let score = 0;
                currentQuestions.forEach((q, index) => {
                    const correctAnswers = Array.isArray(q.answer) ? q.answer : [q.answer];
                    if (correctAnswers.includes(userAnswers[index])) {
                        score++;
                    }
                });

                const percentage = currentQuestions.length > 0 ? ((score / currentQuestions.length) * 100).toFixed(2) : 0;
                let timeTakenInSeconds;

                if (examType === 'exam') {
                    timeTakenInSeconds = totalTime - timeLeft;
                } else {
                    timeTakenInSeconds = startTime > 0 ? Math.floor((Date.now() - startTime) / 1000) : 0;
                }
                
                scoreDisplay.textContent = `${score} / ${currentQuestions.length}`;
                percentageDisplay.textContent = `${percentage}%`;
                timeTakenDisplay.textContent = formatTime(timeTakenInSeconds);
                
                saveHistory(score, percentage, timeTakenInSeconds);

                quizSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                supportIcon.classList.remove('hidden');
                
                showSupportModal(false);
            }

            // --- REVIEW LOGIC ---
            function startReview() {
                reviewQuestionIndex = 0;
                resultsSection.classList.add('hidden');
                reviewSection.classList.remove('hidden');
                displayReviewQuestion();
            }
            
            function displayReviewQuestion() {
                const question = currentQuestions[reviewQuestionIndex];
                const userAnswer = userAnswers[reviewQuestionIndex];
                const correctAnswers = Array.isArray(question.answer) ? question.answer : [question.answer];
                let optionsHtml = '';
                
                question.options.forEach(option => {
                    let classes = 'quiz-option p-4 border rounded-lg mb-3';
                    const isCorrect = correctAnswers.includes(option);
                    const isUserChoice = userAnswer === option;
                    
                    if(isCorrect) {
                        classes += ' correct-answer';
                    }
                    if(isUserChoice && !isCorrect) {
                        classes += ' incorrect-answer';
                    }
                    if(isUserChoice) {
                        classes += ' user-selected';
                    }

                    optionsHtml += `<div class="${classes}">${option}</div>`;
                });

                reviewContainer.innerHTML = `
                    <h3 class="text-2xl font-semibold mb-4">${reviewQuestionIndex + 1}. ${question.question}</h3>
                    <div id="review-options-container">${optionsHtml}</div>
                    <div class="explanation-box">
                        <h4 class="font-bold text-lg mb-2">Explanation:</h4>
                        <p>${question.explanation || 'No explanation available.'}</p>
                    </div>
                `;
                updateReviewNavigation();
            }

            function updateReviewNavigation() {
                reviewProgressIndicator.textContent = `Question ${reviewQuestionIndex + 1} of ${currentQuestions.length}`;
                prevReviewBtn.disabled = reviewQuestionIndex === 0;
                prevReviewBtn.classList.toggle('opacity-50', prevReviewBtn.disabled);
                nextReviewBtn.disabled = reviewQuestionIndex === currentQuestions.length - 1;
                nextReviewBtn.classList.toggle('opacity-50', nextReviewBtn.disabled);
            }

            // --- UTILITIES & HISTORY ---

            function formatTime(totalSeconds) {
                if (isNaN(totalSeconds) || totalSeconds < 0) return '00:00:00';
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            }

            function saveHistory(score, percentage, timeInSeconds) {
                const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
                const now = new Date();
                const newRecord = {
                    seed: examSeed,
                    date: now.toLocaleDateString(),
                    time: now.toLocaleTimeString(),
                    score: `${score} / ${currentQuestions.length}`,
                    percentage: `${percentage}%`,
                    timeTaken: formatTime(timeInSeconds),
                    examType: examType.charAt(0).toUpperCase() + examType.slice(1), // Capitalize first letter
                    domain: activeSeed ? (history.find(r => r.seed === activeSeed).domain) : domainSelect.value,
                    questionCount: currentQuestions.length
                };
                history.unshift(newRecord);
                localStorage.setItem('quizHistory', JSON.stringify(history));
                loadHistory();
            }

            function loadHistory() {
                const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
                historyTableBody.innerHTML = '';
                if (history.length === 0) {
                    historyTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No exam history found.</td></tr>';
                } else {
                    history.forEach(record => {
                        const row = `
                            <tr>
                                <td class="py-2 px-4 border-b font-mono text-xs">${record.seed}</td>
                                <td class="py-2 px-4 border-b">${record.date} ${record.time}</td>
                                <td class="py-2 px-4 border-b">${record.examType || 'N/A'}</td>
                                <td class="py-2 px-4 border-b">${record.score}</td>
                                <td class="py-2 px-4 border-b">${record.percentage}</td>
                                <td class="py-2 px-4 border-b">${record.timeTaken}</td>
                            </tr>`;
                        historyTableBody.innerHTML += row;
                    });
                }
            }
            
            function downloadData(data, filename, type) {
                const blob = new Blob([data], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            function showSupportModal(startAfter = true) {
                supportModal.classList.remove('hidden');
                if (startAfter) {
                    skipSupportBtn.textContent = 'Skip to Exam';
                    skipSupportBtn.onclick = () => {
                        supportModal.classList.add('hidden');
                        beginExam();
                    };
                } else {
                     skipSupportBtn.textContent = 'Close';
                     skipSupportBtn.onclick = () => supportModal.classList.add('hidden');
                }
            }

            function handleSeedInput() {
                const seedValue = seedInput.value.trim();
                const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
                const seedRecord = history.find(r => r.seed === seedValue);

                if (seedRecord) {
                    activeSeed = seedValue;
                    domainSelect.value = seedRecord.domain;
                    updateQuestionCountOptions(); // Update counts based on the new domain
                    questionCountSelect.value = seedRecord.questionCount;
                    
                    domainSelect.disabled = true;
                    questionCountSelect.disabled = true;
                    seedInput.classList.add('border-green-500', 'ring-green-500');
                    seedInput.classList.remove('border-red-500', 'ring-red-500');
                } else {
                    resetSeedState();
                    if (seedValue !== '') {
                         seedInput.classList.add('border-red-500', 'ring-red-500');
                    }
                }
            }
            
            function resetSeedState() {
                activeSeed = '';
                domainSelect.disabled = false;
                questionCountSelect.disabled = false;
                seedInput.value = '';
                seedInput.classList.remove('border-green-500', 'ring-green-500', 'border-red-500', 'ring-red-500');
            }
            
            // --- EVENT LISTENERS ---
            domainSelect.addEventListener('change', updateQuestionCountOptions);
            seedInput.addEventListener('input', handleSeedInput);
            startExamBtn.addEventListener('click', () => { showSupportModal(); });
            restartExamBtn.addEventListener('click', () => {
                resultsSection.classList.add('hidden');
                setupSection.classList.remove('hidden');
                resetSeedState();
            });

            // Quiz Navigation
            nextQuestionBtn.addEventListener('click', () => {
                if (currentQuestionIndex < currentQuestions.length - 1) {
                    currentQuestionIndex++;
                    displayQuestion();
                }
            });
            prevQuestionBtn.addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayQuestion();
                }
            });
            submitExamBtn.addEventListener('click', submitExam);

            // Review Navigation
            reviewExamBtn.addEventListener('click', startReview);
            nextReviewBtn.addEventListener('click', () => {
                if (reviewQuestionIndex < currentQuestions.length - 1) {
                    reviewQuestionIndex++;
                    displayReviewQuestion();
                }
            });
            prevReviewBtn.addEventListener('click', () => {
                if (reviewQuestionIndex > 0) {
                    reviewQuestionIndex--;
                    displayReviewQuestion();
                }
            });
            backToResultsBtn.addEventListener('click', () => {
                reviewSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
            });
            
            // History Listeners
            resetHistoryBtn.addEventListener('click', () => { resetModal.classList.remove('hidden'); });
            cancelResetBtn.addEventListener('click', () => { resetModal.classList.add('hidden'); });
            confirmResetBtn.addEventListener('click', () => {
                localStorage.removeItem('quizHistory');
                loadHistory();
                resetModal.classList.add('hidden');
            });
            downloadJsonBtn.addEventListener('click', () => {
                const history = localStorage.getItem('quizHistory') || '[]';
                downloadData(history, 'quiz_history.json', 'application/json');
            });
            downloadCsvBtn.addEventListener('click', () => {
                const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
                if (history.length === 0) return;
                const headers = Object.keys(history[0]).join(',');
                const rows = history.map(record => `"${Object.values(record).join('","')}"`).join('\n');
                downloadData(`${headers}\n${rows}`, 'quiz_history.csv', 'text/csv');
            });

            // Keyboard and Window Listeners
            window.addEventListener('beforeunload', (e) => {
                if (isQuizActive) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
            document.addEventListener('keydown', (e) => {
                if (!isQuizActive) return;
                if (e.key === 'ArrowRight') nextQuestionBtn.click();
                if (e.key === 'ArrowLeft') prevQuestionBtn.click();
                if(['1','2','3','4'].includes(e.key)) {
                    const optionElement = document.querySelector(`.quiz-option[data-option-index="${parseInt(e.key) - 1}"]`);
                    if(optionElement) handleOptionSelect(optionElement);
                }
            });

            // --- INITIALIZATION ---
            loadQuestions();
            loadHistory();
        });
    </script>
</body>
</html>
